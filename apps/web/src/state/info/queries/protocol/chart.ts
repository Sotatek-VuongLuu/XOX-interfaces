/* eslint-disable no-await-in-loop */
import { gql } from 'graphql-request'
import { useEffect, useState } from 'react'
import { ChartEntry } from 'state/info/types'
import axios from 'axios'
import { fetchChartData, mapDayData } from '../helpers'
import { PancakeDayDatasResponse } from '../types'
import { MultiChainName, getMultiChainQueryEndPointWithStableSwap, multiChainStartTime } from '../../constant'
import { useGetChainName } from '../../hooks'

/**
 * Data for displaying Liquidity and Volume charts on Overview page
 */
const PANCAKE_DAY_DATAS = gql`
  query overviewCharts($startTime: Int!, $skip: Int!) {
    pancakeDayDatas(first: 1000, skip: $skip, where: { date_gt: $startTime }, orderBy: date, orderDirection: asc) {
      date
      dailyVolumeUSD
      totalLiquidityUSD
    }
  }
`

const getOverviewChartData = async (
  chainName: MultiChainName,
  skip: number,
): Promise<{ data?: ChartEntry[]; error: boolean }> => {
  try {
    const { pancakeDayDatas } = await getMultiChainQueryEndPointWithStableSwap(
      chainName,
    ).request<PancakeDayDatasResponse>(PANCAKE_DAY_DATAS, {
      startTime: multiChainStartTime[chainName],
      skip,
    })
    const data = pancakeDayDatas.map(mapDayData)
    return { data, error: false }
  } catch (error) {
    console.error('Failed to fetch overview chart data', error)
    return { error: true }
  }
}

const getOverviewChartDataCustom = async (id: string, filter: any): Promise<{ data?: any[]; error: boolean }> => {
  try {
    const pairDayDatas = await axios
      .get(`https://api.coingecko.com/api/v3/coins/${id}/market_chart`, { params: { vs_currency: 'usd', days: filter.days } })
      .then((result) => {
        return result.data?.prices || []
      })
    const data = [
      [
        1669878168527,
        1285.7980346332176
      ],
      [
        1669881664449,
        1283.357423410757
      ],
      [
        1669885254511,
        1284.604544000236
      ],
      [
        1669888879367,
        1286.643534050332
      ],
      [
        1669892518356,
        1283.13579691732
      ],
      [
        1669896118352,
        1286.663898701043
      ],
      [
        1669899769931,
        1288.7843699669652
      ],
      [
        1669903326871,
        1283.4645455057012
      ],
      [
        1669906983661,
        1286.300991172501
      ],
      [
        1669910520320,
        1275.170336166188
      ],
      [
        1669914182180,
        1273.5429225626308
      ],
      [
        1669917775489,
        1279.4506323469398
      ],
      [
        1669921259452,
        1274.97423678178
      ],
      [
        1669925009151,
        1280.6997033447894
      ],
      [
        1669928540583,
        1275.1338685369574
      ],
      [
        1669932136460,
        1281.5101357380945
      ],
      [
        1669935811666,
        1280.9136797363437
      ],
      [
        1669939257867,
        1276.6393714030964
      ],
      [
        1669942856780,
        1285.2001029146027
      ],
      [
        1669946502557,
        1274.3578182619424
      ],
      [
        1669950018650,
        1273.198472955073
      ],
      [
        1669953672454,
        1272.224580864905
      ],
      [
        1669957267428,
        1273.9117543828725
      ],
      [
        1669960827401,
        1274.3536983767933
      ],
      [
        1669964417846,
        1274.1425671699926
      ],
      [
        1669968109839,
        1276.5876801343638
      ],
      [
        1669971707024,
        1277.6770336630104
      ],
      [
        1669975237249,
        1280.190394073918
      ],
      [
        1669978844274,
        1282.0927633626818
      ],
      [
        1669982402736,
        1290.8400419169743
      ],
      [
        1669986008856,
        1291.1918458682603
      ],
      [
        1669989722732,
        1277.8135200333575
      ],
      [
        1669993268336,
        1283.5307375651066
      ],
      [
        1669996828887,
        1284.508380062597
      ],
      [
        1670000498250,
        1283.2263178845749
      ],
      [
        1670004111956,
        1284.483759946843
      ],
      [
        1670007648887,
        1283.9086205938463
      ],
      [
        1670011209464,
        1287.1019776114301
      ],
      [
        1670014812930,
        1291.4679393098804
      ],
      [
        1670018421534,
        1292.8185668157132
      ],
      [
        1670022095783,
        1293.2626769927328
      ],
      [
        1670025662529,
        1299.0333859445502
      ],
      [
        1670029222546,
        1292.4442319743196
      ],
      [
        1670032812193,
        1292.9967091490553
      ],
      [
        1670036464949,
        1286.8555187127934
      ],
      [
        1670040041661,
        1286.796198549917
      ],
      [
        1670043627568,
        1290.0472394157905
      ],
      [
        1670047234793,
        1289.440771362029
      ],
      [
        1670050846459,
        1285.5133633690077
      ],
      [
        1670054432540,
        1278.1966172571001
      ],
      [
        1670058067181,
        1270.5463463529143
      ],
      [
        1670061602657,
        1273.476156170256
      ],
      [
        1670065245971,
        1272.0934250509008
      ],
      [
        1670068809720,
        1270.2469941677368
      ],
      [
        1670072464056,
        1273.656923010411
      ],
      [
        1670076008246,
        1271.8943288007265
      ],
      [
        1670079644801,
        1272.3951695754747
      ],
      [
        1670083268111,
        1272.9165098658304
      ],
      [
        1670086853181,
        1269.2740001934803
      ],
      [
        1670090436020,
        1271.7302203538634
      ],
      [
        1670094067738,
        1271.0873048051596
      ],
      [
        1670097646931,
        1267.5537541463862
      ],
      [
        1670101234680,
        1265.2116590896915
      ],
      [
        1670104822934,
        1265.781544090923
      ],
      [
        1670108443911,
        1241.8714325240037
      ],
      [
        1670112035496,
        1243.2431539042907
      ],
      [
        1670115645521,
        1252.4649570929396
      ],
      [
        1670119225197,
        1257.6950772029556
      ],
      [
        1670122854680,
        1260.7504864646137
      ],
      [
        1670126506421,
        1261.1443481971758
      ],
      [
        1670130064254,
        1263.6411290822582
      ],
      [
        1670133662177,
        1261.3352645444013
      ],
      [
        1670137311474,
        1257.8823837052726
      ],
      [
        1670140859821,
        1258.1737291810741
      ],
      [
        1670144512140,
        1259.6660883954576
      ],
      [
        1670148030816,
        1258.3434582535674
      ],
      [
        1670151626817,
        1260.0821964544145
      ],
      [
        1670155310581,
        1256.174245656721
      ],
      [
        1670158826575,
        1257.452437805164
      ],
      [
        1670162445485,
        1254.666765130357
      ],
      [
        1670166079114,
        1260.1639048079567
      ],
      [
        1670169713331,
        1260.3018457836642
      ],
      [
        1670173284696,
        1259.551485203997
      ],
      [
        1670176830665,
        1265.1423463077433
      ],
      [
        1670180427121,
        1270.8792005552511
      ],
      [
        1670184104160,
        1279.884692362143
      ],
      [
        1670187643062,
        1279.179890130919
      ],
      [
        1670191307181,
        1278.4050352881695
      ],
      [
        1670194854881,
        1276.882476600466
      ],
      [
        1670198436131,
        1281.3115514741726
      ],
      [
        1670202059124,
        1289.1106887787673
      ],
      [
        1670205767265,
        1290.7185760502848
      ],
      [
        1670209223260,
        1295.46238720796
      ],
      [
        1670212847028,
        1292.6996017129663
      ],
      [
        1670216473070,
        1300.3885500429337
      ],
      [
        1670220007663,
        1297.0057206605331
      ],
      [
        1670223658681,
        1296.3540362575472
      ],
      [
        1670227347009,
        1299.6126112736588
      ],
      [
        1670230835515,
        1302.2175639645632
      ],
      [
        1670234421321,
        1295.9811746212486
      ],
      [
        1670238279270,
        1297.9902316247724
      ],
      [
        1670241709690,
        1294.8054617732707
      ],
      [
        1670245320853,
        1290.9038035063204
      ],
      [
        1670248876367,
        1289.5781124505365
      ],
      [
        1670252462996,
        1285.8862448355897
      ],
      [
        1670256050084,
        1267.137411101022
      ],
      [
        1670259623223,
        1261.1817270150102
      ],
      [
        1670263363611,
        1266.132685498557
      ],
      [
        1670266922031,
        1264.8804320939696
      ],
      [
        1670270473300,
        1254.7685425608333
      ],
      [
        1670274058444,
        1256.7439114431074
      ],
      [
        1670277641803,
        1259.4341752694804
      ],
      [
        1670281221392,
        1260.2372725287134
      ],
      [
        1670284809299,
        1260.0535047674123
      ],
      [
        1670288472162,
        1267.2388136020413
      ],
      [
        1670292036729,
        1265.1841452631913
      ],
      [
        1670295617361,
        1266.2717670941
      ],
      [
        1670299293183,
        1262.9230122145887
      ],
      [
        1670302950517,
        1262.5919607492824
      ],
      [
        1670306436227,
        1258.0640904306392
      ],
      [
        1670310121422,
        1261.6211298734195
      ],
      [
        1670313721864,
        1260.2937803346995
      ],
      [
        1670317204207,
        1261.6492090766446
      ],
      [
        1670320908925,
        1257.3765697000376
      ],
      [
        1670324515641,
        1254.0961278176105
      ],
      [
        1670328121518,
        1256.2539705653146
      ],
      [
        1670331732081,
        1259.323487055416
      ],
      [
        1670335321587,
        1255.3624766942717
      ],
      [
        1670338914604,
        1254.0962972834268
      ],
      [
        1670342464658,
        1256.0088611387387
      ],
      [
        1670346122295,
        1256.1106803219304
      ],
      [
        1670349723729,
        1252.1537716353223
      ],
      [
        1670353240535,
        1250.8686466567135
      ],
      [
        1670356912351,
        1249.8889900829092
      ],
      [
        1670360514629,
        1252.6865061279168
      ],
      [
        1670364174028,
        1255.9236614826677
      ],
      [
        1670367629231,
        1253.8416824995413
      ],
      [
        1670371229647,
        1271.9354761263946
      ],
      [
        1670374911633,
        1270.210655006499
      ],
      [
        1670378569704,
        1264.8727810209048
      ],
      [
        1670382008290,
        1266.2964111786382
      ],
      [
        1670385723561,
        1263.0882565053523
      ],
      [
        1670389325001,
        1263.8336570260726
      ],
      [
        1670392919308,
        1260.6249100531147
      ],
      [
        1670396519057,
        1250.6015691506018
      ],
      [
        1670400148030,
        1226.89784835666
      ],
      [
        1670403742733,
        1230.3236012046427
      ],
      [
        1670407301255,
        1230.8410520694931
      ],
      [
        1670410837414,
        1230.561723853407
      ],
      [
        1670414467656,
        1225.6851191409728
      ],
      [
        1670418175148,
        1225.024058752813
      ],
      [
        1670421711581,
        1233.8435252522288
      ],
      [
        1670425310960,
        1234.6989406046625
      ],
      [
        1670428842354,
        1232.7105246888243
      ],
      [
        1670432513143,
        1229.7078194987903
      ],
      [
        1670436037414,
        1231.7416396451772
      ],
      [
        1670439684938,
        1231.897702015389
      ],
      [
        1670443287609,
        1233.230994762092
      ],
      [
        1670446933517,
        1233.5100405323194
      ],
      [
        1670450442507,
        1231.2808571024218
      ],
      [
        1670454056803,
        1230.5162888456066
      ],
      [
        1670457686759,
        1232.8281223743709
      ],
      [
        1670461264776,
        1231.2864149405434
      ],
      [
        1670464945985,
        1228.1565048167242
      ],
      [
        1670468507003,
        1233.3500949862153
      ],
      [
        1670472109566,
        1232.7664906318998
      ],
      [
        1670475616246,
        1229.3583993278787
      ],
      [
        1670479311622,
        1229.417968355209
      ],
      [
        1670483393000,
        1230.3770709788373
      ]
    ].map((d) => {
      return {
        date: d[0],
        priceUSD: d[1],
      }
    })
    return { data, error: false }
  } catch (error) {
    console.error('Failed to fetch overview chart data', error)
    return { error: true }
  }
}

/**
 * Fetch historic chart data
 */
const useFetchGlobalChartData = (): {
  error: boolean
  data: ChartEntry[] | undefined
} => {
  const [overviewChartData, setOverviewChartData] = useState<ChartEntry[] | undefined>()
  const [error, setError] = useState(false)
  const chainName = useGetChainName()

  useEffect(() => {
    const fetch = async () => {
      const { data } = await fetchChartData(chainName, getOverviewChartData)
      if (data) {
        setOverviewChartData(data)
      } else {
        setError(true)
      }
    }
    if (!overviewChartData && !error) {
      fetch()
    }
  }, [overviewChartData, error, chainName])

  return {
    error,
    data: overviewChartData,
  }
}

export const fetchGlobalChartData = async (id: string, filter: any, chainName: MultiChainName) => {
  const data = await getOverviewChartDataCustom(id, filter)
  return data
}

export default useFetchGlobalChartData
